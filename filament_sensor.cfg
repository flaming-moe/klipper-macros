[delayed_gcode DISABLEFILAMENTSENSOR] ;This will disable the filament sensor second after klipper starts
initial_duration: 1
gcode:
  SFS_DISABLE

[gcode_macro SFS_ENABLE] ; Add this to PRINT_START
description: Enable smart filament sensor
gcode:
  set_smart_filament_sensor enable=1

[gcode_macro SFS_DISABLE] ; Add this to PRINT_END and PRINT_CANCEL
description: Disable smart filament sensor 
gcode:
  set_smart_filament_sensor enable=0

[gcode_macro set_smart_filament_sensor]
description: Enable or disable the smart filament sensor
gcode:
  {% if params.ENABLE %}
    {% set flag = params.ENABLE | int %}
    {% if flag == 0 %}
      {% set enabled=0 | int %} 
    {% else %}
      {% set enabled=1 | int %} 
    {% endif %}
  {% else %}
     {% set enabled=0 | int %} 
  {% endif %}
  {% if enabled == 0 %}
    {% set action = "Disabling" | string %}
  {% else %}
    {% set action = "Enabling" | string %}
  {% endif %}
  {% set settings = printer["gcode_macro _macro_globals"] %}
  {% set filament_sensor_name = settings.filament_sensor_name|default('none')|string %}
  {% set switch_sensor_name = settings.switch_sensor_name|default('none')|string %}
  _verbose msg="set_smart_filament_sensor[filament_sensor_name: {filament_sensor_name}, switch_sensor_name: {switch_sensor_name}, enabled: {enabled}]"
  {% if filament_sensor_name != 'none' %}
    _verbose msg="{action} filament sensor {filament_sensor_name}"
    SET_FILAMENT_SENSOR SENSOR={filament_sensor_name} ENABLE={enabled}
  {% endif %}
  {% if switch_sensor_name != 'none' %}
    _verbose msg="{action} switch sensor {switch_sensor_name}"
    SET_FILAMENT_SENSOR SENSOR={switch_sensor_name} ENABLE={enabled}
  {% endif %}
